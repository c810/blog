---
title: HashMap
publish: false
---

## HashMap

### HashMap çš„åº•å±‚å®ç°

#### JDK1.8 ä¹‹å‰

JDK1.8 ä¹‹å‰ `HashMap` åº•å±‚æ˜¯ **æ•°ç»„å’Œé“¾è¡¨** ç»“åˆåœ¨ä¸€èµ·ä½¿ç”¨ä¹Ÿå°±æ˜¯ **é“¾è¡¨æ•£åˆ—**ã€‚HashMap é€šè¿‡ key çš„ `hashcode` ç»è¿‡æ‰°åŠ¨å‡½æ•°å¤„ç†è¿‡åå¾—åˆ° hash å€¼ï¼Œç„¶åé€šè¿‡ `(n - 1) & hash` åˆ¤æ–­å½“å‰å…ƒç´ å­˜æ”¾çš„ä½ç½®ï¼ˆè¿™é‡Œçš„ n æŒ‡çš„æ˜¯æ•°ç»„çš„é•¿åº¦ï¼‰ï¼Œå¦‚æœå½“å‰ä½ç½®å­˜åœ¨å…ƒç´ çš„è¯ï¼Œå°±åˆ¤æ–­è¯¥å…ƒç´ ä¸è¦å­˜å…¥çš„å…ƒç´ çš„ hash å€¼ä»¥åŠ key æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒçš„è¯ï¼Œç›´æ¥è¦†ç›–ï¼Œä¸ç›¸åŒå°±é€šè¿‡æ‹‰é“¾æ³•è§£å†³å†²çªã€‚

æ‰€è°“æ‰°åŠ¨å‡½æ•°æŒ‡çš„å°±æ˜¯ HashMap çš„ `hash` æ–¹æ³•ã€‚ä½¿ç”¨ `hash` æ–¹æ³•ä¹Ÿå°±æ˜¯æ‰°åŠ¨å‡½æ•°æ˜¯ä¸ºäº†é˜²æ­¢ä¸€äº›å®ç°æ¯”è¾ƒå·®çš„ `hashCode()` æ–¹æ³• æ¢å¥è¯è¯´ä½¿ç”¨æ‰°åŠ¨å‡½æ•°ä¹‹åå¯ä»¥å‡å°‘ç¢°æ’ã€‚

**JDK 1.8 HashMap çš„ hash æ–¹æ³•æºç :**

JDK 1.8 çš„ hash æ–¹æ³• ç›¸æ¯”äº JDK 1.7 hash æ–¹æ³•æ›´åŠ ç®€åŒ–ï¼Œä½†æ˜¯åŸç†ä¸å˜ã€‚

```java
    static final int hash(Object key) {
      int h;
      // key.hashCode()ï¼šè¿”å›æ•£åˆ—å€¼ä¹Ÿå°±æ˜¯hashcode
      // ^ï¼šæŒ‰ä½å¼‚æˆ–
      // >>>:æ— ç¬¦å·å³ç§»ï¼Œå¿½ç•¥ç¬¦å·ä½ï¼Œç©ºä½éƒ½ä»¥0è¡¥é½
      return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
  }
```

å¯¹æ¯”ä¸€ä¸‹ JDK1.7 çš„ HashMap çš„ hash æ–¹æ³•æºç .

```java
static int hash(int h) {
    // This function ensures that hashCodes that differ only by
    // constant multiples at each bit position have a bounded
    // number of collisions (approximately 8 at default load factor).

    h ^= (h >>> 20) ^ (h >>> 12);
    return h ^ (h >>> 7) ^ (h >>> 4);
}
```

ç›¸æ¯”äº JDK1.8 çš„ hash æ–¹æ³• ï¼ŒJDK 1.7 çš„ hash æ–¹æ³•çš„æ€§èƒ½ä¼šç¨å·®ä¸€ç‚¹ç‚¹ï¼Œå› ä¸ºæ¯•ç«Ÿæ‰°åŠ¨äº† 4 æ¬¡ã€‚

æ‰€è°“ **â€œæ‹‰é“¾æ³•â€** å°±æ˜¯ï¼šå°†é“¾è¡¨å’Œæ•°ç»„ç›¸ç»“åˆã€‚ä¹Ÿå°±æ˜¯è¯´åˆ›å»ºä¸€ä¸ªé“¾è¡¨æ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸€æ ¼å°±æ˜¯ä¸€ä¸ªé“¾è¡¨ã€‚è‹¥é‡åˆ°å“ˆå¸Œå†²çªï¼Œåˆ™å°†å†²çªçš„å€¼åŠ åˆ°é“¾è¡¨ä¸­å³å¯ã€‚

![jdk1.8 ä¹‹å‰çš„å†…éƒ¨ç»“æ„-HashMap](https://oss.javaguide.cn/github/javaguide/java/collection/jdk1.7_hashmap.png)

#### JDK1.8 ä¹‹å

ç›¸æ¯”äºä¹‹å‰çš„ç‰ˆæœ¬ï¼Œ JDK1.8 ä¹‹ååœ¨è§£å†³å“ˆå¸Œå†²çªæ—¶æœ‰äº†è¾ƒå¤§çš„å˜åŒ–ï¼Œå½“é“¾è¡¨é•¿åº¦å¤§äºé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8ï¼‰ï¼ˆå°†é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘å‰ä¼šåˆ¤æ–­ï¼Œå¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©å…ˆè¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼‰æ—¶ï¼Œå°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œä»¥å‡å°‘æœç´¢æ—¶é—´ã€‚

![jdk1.8ä¹‹åçš„å†…éƒ¨ç»“æ„-HashMap](https://oss.javaguide.cn/github/javaguide/java/collection/jdk1.8_hashmap.png)

> TreeMapã€TreeSet ä»¥åŠ JDK1.8 ä¹‹åçš„ HashMap åº•å±‚éƒ½ç”¨åˆ°äº†çº¢é»‘æ ‘ã€‚çº¢é»‘æ ‘å°±æ˜¯ä¸ºäº†è§£å†³äºŒå‰æŸ¥æ‰¾æ ‘çš„ç¼ºé™·ï¼Œå› ä¸ºäºŒå‰æŸ¥æ‰¾æ ‘åœ¨æŸäº›æƒ…å†µä¸‹ä¼šé€€åŒ–æˆä¸€ä¸ªçº¿æ€§ç»“æ„ã€‚

æˆ‘ä»¬æ¥ç»“åˆæºç åˆ†æä¸€ä¸‹ `HashMap` é“¾è¡¨åˆ°çº¢é»‘æ ‘çš„è½¬æ¢ã€‚

**1ã€ `putVal` æ–¹æ³•ä¸­æ‰§è¡Œé“¾è¡¨è½¬çº¢é»‘æ ‘çš„åˆ¤æ–­é€»è¾‘ã€‚**

é“¾è¡¨çš„é•¿åº¦å¤§äº 8 çš„æ—¶å€™ï¼Œå°±æ‰§è¡Œ `treeifyBin` ï¼ˆè½¬æ¢çº¢é»‘æ ‘ï¼‰çš„é€»è¾‘ã€‚

```java
// éå†é“¾è¡¨
for (int binCount = 0; ; ++binCount) {
    // éå†åˆ°é“¾è¡¨æœ€åä¸€ä¸ªèŠ‚ç‚¹
    if ((e = p.next) == null) {
        p.next = newNode(hash, key, value, null);
        // å¦‚æœé“¾è¡¨å…ƒç´ ä¸ªæ•°å¤§äºTREEIFY_THRESHOLDï¼ˆ8ï¼‰
        if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st
            // çº¢é»‘æ ‘è½¬æ¢ï¼ˆå¹¶ä¸ä¼šç›´æ¥è½¬æ¢æˆçº¢é»‘æ ‘ï¼‰
            treeifyBin(tab, hash);
        break;
    }
    if (e.hash == hash &&
        ((k = e.key) == key || (key != null && key.equals(k))))
        break;
    p = e;
}
```

**2ã€`treeifyBin` æ–¹æ³•ä¸­åˆ¤æ–­æ˜¯å¦çœŸçš„è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚**

```java
final void treeifyBin(Node<K,V>[] tab, int hash) {
    int n, index; Node<K,V> e;
    // åˆ¤æ–­å½“å‰æ•°ç»„çš„é•¿åº¦æ˜¯å¦å°äº 64
    if (tab == null || (n = tab.length) < MIN_TREEIFY_CAPACITY)
        // å¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©å…ˆè¿›è¡Œæ•°ç»„æ‰©å®¹
        resize();
    else if ((e = tab[index = (n - 1) & hash]) != null) {
        // å¦åˆ™æ‰å°†åˆ—è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘

        TreeNode<K,V> hd = null, tl = null;
        do {
            TreeNode<K,V> p = replacementTreeNode(e, null);
            if (tl == null)
                hd = p;
            else {
                p.prev = tl;
                tl.next = p;
            }
            tl = p;
        } while ((e = e.next) != null);
        if ((tab[index] = hd) != null)
            hd.treeify(tab);
    }
}
```

å°†é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘å‰ä¼šåˆ¤æ–­ï¼Œå¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©å…ˆè¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚

[[è¯´ä¸€ä¸‹ HashMap çš„å®ç°åŸç†ï¼Ÿ]]

[[HashMap çš„ jdk1.7 å’Œ jdk1.8 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ]]

## put() è¿‡ç¨‹è§£æ
### HashMap å¸¸è§å±æ€§

![[image-20230428210404117.png]]

### æºç è§£æ

![[image-20230428210450744.png]]

- HashMap æ˜¯æ‡’æƒ°åŠ è½½ï¼Œåœ¨åˆ›å»ºå¯¹è±¡æ—¶å¹¶æ²¡æœ‰åˆå§‹åŒ–æ•°ç»„
- åœ¨æ— å‚çš„æ„é€ å‡½æ•°ä¸­ï¼Œè®¾ç½®äº†é»˜è®¤çš„åŠ è½½å› å­æ˜¯ 0.75

æ·»åŠ æ•°æ®æµç¨‹å›¾

![[image-20230428210624847.png]]

å…·ä½“çš„æºç ï¼š

```java
public V put(K key, V value) {
    return putVal(hash(key), key, value, false, true);
}

final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
                   boolean evict) {
    Node<K,V>[] tab; Node<K,V> p; int n, i;
    //åˆ¤æ–­æ•°ç»„æ˜¯å¦æœªåˆå§‹åŒ–
    if ((tab = table) == null || (n = tab.length) == 0)
        //å¦‚æœæœªåˆå§‹åŒ–ï¼Œè°ƒç”¨resizeæ–¹æ³• è¿›è¡Œåˆå§‹åŒ–
        n = (tab = resize()).length;
    //é€šè¿‡ & è¿ç®—æ±‚å‡ºè¯¥æ•°æ®ï¼ˆkeyï¼‰çš„æ•°ç»„ä¸‹æ ‡å¹¶åˆ¤æ–­è¯¥ä¸‹æ ‡ä½ç½®æ˜¯å¦æœ‰æ•°æ®
    if ((p = tab[i = (n - 1) & hash]) == null)
        //å¦‚æœæ²¡æœ‰ï¼Œç›´æ¥å°†æ•°æ®æ”¾åœ¨è¯¥ä¸‹æ ‡ä½ç½®
        tab[i] = newNode(hash, key, value, null);
    //è¯¥æ•°ç»„ä¸‹æ ‡æœ‰æ•°æ®çš„æƒ…å†µ
    else {
        Node<K,V> e; K k;
        //åˆ¤æ–­è¯¥ä½ç½®æ•°æ®çš„keyå’Œæ–°æ¥çš„æ•°æ®æ˜¯å¦ä¸€æ ·
        if (p.hash == hash &&
            ((k = p.key) == key || (key != null && key.equals(k))))
            //å¦‚æœä¸€æ ·ï¼Œè¯æ˜ä¸ºä¿®æ”¹æ“ä½œï¼Œè¯¥èŠ‚ç‚¹çš„æ•°æ®èµ‹å€¼ç»™e,åè¾¹ä¼šç”¨åˆ°
            e = p;
        //åˆ¤æ–­æ˜¯ä¸æ˜¯çº¢é»‘æ ‘
        else if (p instanceof TreeNode)
            //å¦‚æœæ˜¯çº¢é»‘æ ‘çš„è¯ï¼Œè¿›è¡Œçº¢é»‘æ ‘çš„æ“ä½œ
            e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);
        //æ–°æ•°æ®å’Œå½“å‰æ•°ç»„æ—¢ä¸ç›¸åŒï¼Œä¹Ÿä¸æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹ï¼Œè¯æ˜æ˜¯é“¾è¡¨
        else {
            //éå†é“¾è¡¨
            for (int binCount = 0; ; ++binCount) {
                //åˆ¤æ–­nextèŠ‚ç‚¹ï¼Œå¦‚æœä¸ºç©ºçš„è¯ï¼Œè¯æ˜éå†åˆ°é“¾è¡¨å°¾éƒ¨äº†
                if ((e = p.next) == null) {
                    //æŠŠæ–°å€¼æ”¾å…¥é“¾è¡¨å°¾éƒ¨
                    p.next = newNode(hash, key, value, null);
                    //å› ä¸ºæ–°æ’å…¥äº†ä¸€æ¡æ•°æ®ï¼Œæ‰€ä»¥åˆ¤æ–­é“¾è¡¨é•¿åº¦æ˜¯ä¸æ˜¯å¤§äºç­‰äº8
                    if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st
                        //å¦‚æœæ˜¯ï¼Œè¿›è¡Œè½¬æ¢çº¢é»‘æ ‘æ“ä½œ
                        treeifyBin(tab, hash);
                    break;
                }
                //åˆ¤æ–­é“¾è¡¨å½“ä¸­æœ‰æ•°æ®ç›¸åŒçš„å€¼ï¼Œå¦‚æœä¸€æ ·ï¼Œè¯æ˜ä¸ºä¿®æ”¹æ“ä½œ
                if (e.hash == hash &&
                    ((k = e.key) == key || (key != null && key.equals(k))))
                    break;
                //æŠŠä¸‹ä¸€ä¸ªèŠ‚ç‚¹èµ‹å€¼ä¸ºå½“å‰èŠ‚ç‚¹
                p = e;
            }
        }
        //åˆ¤æ–­eæ˜¯å¦ä¸ºç©ºï¼ˆeå€¼ä¸ºä¿®æ”¹æ“ä½œå­˜æ”¾åŸæ•°æ®çš„å˜é‡ï¼‰
        if (e != null) { // existing mapping for key
            //ä¸ä¸ºç©ºçš„è¯è¯æ˜æ˜¯ä¿®æ”¹æ“ä½œï¼Œå–å‡ºè€å€¼
            V oldValue = e.value;
            //ä¸€å®šä¼šæ‰§è¡Œ  onlyIfAbsentä¼ è¿›æ¥çš„æ˜¯false
            if (!onlyIfAbsent || oldValue == null)
                //å°†æ–°å€¼èµ‹å€¼å½“å‰èŠ‚ç‚¹
                e.value = value;
            afterNodeAccess(e);
            //è¿”å›è€å€¼
            return oldValue;
        }
    }
    //è®¡æ•°å™¨ï¼Œè®¡ç®—å½“å‰èŠ‚ç‚¹çš„ä¿®æ”¹æ¬¡æ•°
    ++modCount;
    //å½“å‰æ•°ç»„ä¸­çš„æ•°æ®æ•°é‡å¦‚æœå¤§äºæ‰©å®¹é˜ˆå€¼
    if (++size > threshold)
        //è¿›è¡Œæ‰©å®¹æ“ä½œ
        resize();
    //ç©ºæ–¹æ³•
    afterNodeInsertion(evict);
    //æ·»åŠ æ“ä½œæ—¶ è¿”å›ç©ºå€¼
    return null;
}
```

[[è°ˆè°ˆ HashMap çš„ put æ–¹æ³•çš„å…·ä½“æµç¨‹]]

## HashMap æ‰©å®¹æœºåˆ¶

![[image-20230428210844694.png]]

æ‰©å®¹çš„æµç¨‹ï¼š

![[image-20230428211031968.png]]

æºç ï¼š

```java
//æ‰©å®¹ã€åˆå§‹åŒ–æ•°ç»„
final Node<K,V>[] resize() {
        Node<K,V>[] oldTab = table;
    	//å¦‚æœå½“å‰æ•°ç»„ä¸ºnullçš„æ—¶å€™ï¼ŒæŠŠoldCapè€æ•°ç»„å®¹é‡è®¾ç½®ä¸º0
        int oldCap = (oldTab == null) ? 0 : oldTab.length;
        //è€çš„æ‰©å®¹é˜ˆå€¼
    	int oldThr = threshold;
        int newCap, newThr = 0;
        //åˆ¤æ–­æ•°ç»„å®¹é‡æ˜¯å¦å¤§äº0ï¼Œå¤§äº0è¯´æ˜æ•°ç»„å·²ç»åˆå§‹åŒ–
    	if (oldCap > 0) {
            //åˆ¤æ–­å½“å‰æ•°ç»„é•¿åº¦æ˜¯å¦å¤§äºæœ€å¤§æ•°ç»„é•¿åº¦
            if (oldCap >= MAXIMUM_CAPACITY) {
                //å¦‚æœæ˜¯ï¼Œå°†æ‰©å®¹é˜ˆå€¼ç›´æ¥è®¾ç½®ä¸ºintç±»å‹çš„æœ€å¤§æ•°å€¼å¹¶ç›´æ¥è¿”å›
                threshold = Integer.MAX_VALUE;
                return oldTab;
            }
            //å¦‚æœåœ¨æœ€å¤§é•¿åº¦èŒƒå›´å†…ï¼Œåˆ™éœ€è¦æ‰©å®¹  OldCap << 1ç­‰ä»·äºoldCap*2
            //è¿ç®—è¿‡ååˆ¤æ–­æ˜¯ä¸æ˜¯æœ€å¤§å€¼å¹¶ä¸”oldCapéœ€è¦å¤§äº16
            else if ((newCap = oldCap << 1) < MAXIMUM_CAPACITY &&
                     oldCap >= DEFAULT_INITIAL_CAPACITY)
                newThr = oldThr << 1; // double threshold  ç­‰ä»·äºoldThr*2
        }
    	//å¦‚æœoldCap<0ï¼Œä½†æ˜¯å·²ç»åˆå§‹åŒ–äº†ï¼ŒåƒæŠŠå…ƒç´ åˆ é™¤å®Œä¹‹åçš„æƒ…å†µï¼Œé‚£ä¹ˆå®ƒçš„ä¸´ç•Œå€¼è‚¯å®šè¿˜å­˜åœ¨ï¼Œ       			å¦‚æœæ˜¯é¦–æ¬¡åˆå§‹åŒ–ï¼Œå®ƒçš„ä¸´ç•Œå€¼åˆ™ä¸º0
        else if (oldThr > 0) // initial capacity was placed in threshold
            newCap = oldThr;
        //æ•°ç»„æœªåˆå§‹åŒ–çš„æƒ…å†µï¼Œå°†é˜ˆå€¼å’Œæ‰©å®¹å› å­éƒ½è®¾ç½®ä¸ºé»˜è®¤å€¼
    	else {               // zero initial threshold signifies using defaults
            newCap = DEFAULT_INITIAL_CAPACITY;
            newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);
        }
    	//åˆå§‹åŒ–å®¹é‡å°äº16çš„æ—¶å€™ï¼Œæ‰©å®¹é˜ˆå€¼æ˜¯æ²¡æœ‰èµ‹å€¼çš„
        if (newThr == 0) {
            //åˆ›å»ºé˜ˆå€¼
            float ft = (float)newCap * loadFactor;
            //åˆ¤æ–­æ–°å®¹é‡å’Œæ–°é˜ˆå€¼æ˜¯å¦å¤§äºæœ€å¤§å®¹é‡
            newThr = (newCap < MAXIMUM_CAPACITY && ft < (float)MAXIMUM_CAPACITY ?
                      (int)ft : Integer.MAX_VALUE);
        }
    	//è®¡ç®—å‡ºæ¥çš„é˜ˆå€¼èµ‹å€¼
        threshold = newThr;
        @SuppressWarnings({"rawtypes","unchecked"})
        //æ ¹æ®ä¸Šè¾¹è®¡ç®—å¾—å‡ºçš„å®¹é‡ åˆ›å»ºæ–°çš„æ•°ç»„       
    	Node<K,V>[] newTab = (Node<K,V>[])new Node[newCap];
    	//èµ‹å€¼
    	table = newTab;
    	//æ‰©å®¹æ“ä½œï¼Œåˆ¤æ–­ä¸ä¸ºç©ºè¯æ˜ä¸æ˜¯åˆå§‹åŒ–æ•°ç»„
        if (oldTab != null) {
            //éå†æ•°ç»„
            for (int j = 0; j < oldCap; ++j) {
                Node<K,V> e;
                //åˆ¤æ–­å½“å‰ä¸‹æ ‡ä¸ºjçš„æ•°ç»„å¦‚æœä¸ä¸ºç©ºçš„è¯èµ‹å€¼ä¸ªeï¼Œè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œ
                if ((e = oldTab[j]) != null) {
                    //å°†æ•°ç»„ä½ç½®ç½®ç©º
                    oldTab[j] = null;
                    //åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸ªèŠ‚ç‚¹
                    if (e.next == null)
                        //å¦‚æœæ²¡æœ‰ï¼Œå°±é‡æ–°è®¡ç®—åœ¨æ–°æ•°ç»„ä¸­çš„ä¸‹æ ‡å¹¶æ”¾è¿›å»
                        newTab[e.hash & (newCap - 1)] = e;
                   	//æœ‰ä¸‹ä¸ªèŠ‚ç‚¹çš„æƒ…å†µï¼Œå¹¶ä¸”åˆ¤æ–­æ˜¯å¦å·²ç»æ ‘åŒ–
                    else if (e instanceof TreeNode)
                        //è¿›è¡Œçº¢é»‘æ ‘çš„æ“ä½œ
                        ((TreeNode<K,V>)e).split(this, newTab, j, oldCap);
                    //æœ‰ä¸‹ä¸ªèŠ‚ç‚¹çš„æƒ…å†µï¼Œå¹¶ä¸”æ²¡æœ‰æ ‘åŒ–ï¼ˆé“¾è¡¨å½¢å¼ï¼‰
                    else {
                        //æ¯”å¦‚è€æ•°ç»„å®¹é‡æ˜¯16ï¼Œé‚£ä¸‹æ ‡å°±ä¸º0-15
                        //æ‰©å®¹æ“ä½œ*2ï¼Œå®¹é‡å°±å˜ä¸º32ï¼Œä¸‹æ ‡ä¸º0-31
                        //ä½ä½ï¼š0-15ï¼Œé«˜ä½16-31
                        //å®šä¹‰äº†å››ä¸ªå˜é‡
                        //        ä½ä½å¤´          ä½ä½å°¾
                        Node<K,V> loHead = null, loTail = null;
                        //        é«˜ä½å¤´		   é«˜ä½å°¾
                        Node<K,V> hiHead = null, hiTail = null;
                        //ä¸‹ä¸ªèŠ‚ç‚¹
                        Node<K,V> next;
                        //å¾ªç¯éå†
                        do {
                            //å–å‡ºnextèŠ‚ç‚¹
                            next = e.next;
                            //é€šè¿‡ ä¸æ“ä½œ è®¡ç®—å¾—å‡ºç»“æœä¸º0
                            if ((e.hash & oldCap) == 0) {
                                //å¦‚æœä½ä½å°¾ä¸ºnullï¼Œè¯æ˜å½“å‰æ•°ç»„ä½ç½®ä¸ºç©ºï¼Œæ²¡æœ‰ä»»ä½•æ•°æ®
                                if (loTail == null)
                                    //å°†eå€¼æ”¾å…¥ä½ä½å¤´
                                    loHead = e;
                                //ä½ä½å°¾ä¸ä¸ºnullï¼Œè¯æ˜å·²ç»æœ‰æ•°æ®äº†
                                else
                                    //å°†æ•°æ®æ”¾å…¥nextèŠ‚ç‚¹
                                    loTail.next = e;
                                //è®°å½•ä½ä½å°¾æ•°æ®
                                loTail = e;
                            }
                            //é€šè¿‡ ä¸æ“ä½œ è®¡ç®—å¾—å‡ºç»“æœä¸ä¸º0
                            else {
                                 //å¦‚æœé«˜ä½å°¾ä¸ºnullï¼Œè¯æ˜å½“å‰æ•°ç»„ä½ç½®ä¸ºç©ºï¼Œæ²¡æœ‰ä»»ä½•æ•°æ®
                                if (hiTail == null)
                                    //å°†eå€¼æ”¾å…¥é«˜ä½å¤´
                                    hiHead = e;
                                //é«˜ä½å°¾ä¸ä¸ºnullï¼Œè¯æ˜å·²ç»æœ‰æ•°æ®äº†
                                else
                                    //å°†æ•°æ®æ”¾å…¥nextèŠ‚ç‚¹
                                    hiTail.next = e;
                               //è®°å½•é«˜ä½å°¾æ•°æ®
                               	hiTail = e;
                            }
                            
                        } 
                        //å¦‚æœeä¸ä¸ºç©ºï¼Œè¯æ˜æ²¡æœ‰åˆ°é“¾è¡¨å°¾éƒ¨ï¼Œç»§ç»­æ‰§è¡Œå¾ªç¯
                        while ((e = next) != null);
                        //ä½ä½å°¾å¦‚æœè®°å½•çš„æœ‰æ•°æ®ï¼Œæ˜¯é“¾è¡¨
                        if (loTail != null) {
                            //å°†ä¸‹ä¸€ä¸ªå…ƒç´ ç½®ç©º
                            loTail.next = null;
                            //å°†ä½ä½å¤´æ”¾å…¥æ–°æ•°ç»„çš„åŸä¸‹æ ‡ä½ç½®
                            newTab[j] = loHead;
                        }
                        //é«˜ä½å°¾å¦‚æœè®°å½•çš„æœ‰æ•°æ®ï¼Œæ˜¯é“¾è¡¨
                        if (hiTail != null) {
                            //å°†ä¸‹ä¸€ä¸ªå…ƒç´ ç½®ç©º
                            hiTail.next = null;
                            //å°†é«˜ä½å¤´æ”¾å…¥æ–°æ•°ç»„çš„(åŸä¸‹æ ‡+åŸæ•°ç»„å®¹é‡)ä½ç½®
                            newTab[j + oldCap] = hiHead;
                        }
                    }
                }
            }
        }
    	//è¿”å›æ–°çš„æ•°ç»„å¯¹è±¡
        return newTab;
    }
```

[[è®²ä¸€è®² HashMap çš„æ‰©å®¹æœºåˆ¶]]

## HashMap å¯»å€ç®—æ³•ï¼ˆäºŒæ¬¡ hashï¼‰

![[image-20230428212501408.png]]

åœ¨ putVal æ–¹æ³•ä¸­ï¼Œæœ‰ä¸€ä¸ª hash(key) æ–¹æ³•ï¼ˆäºŒæ¬¡å“ˆå¸Œï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æ¥å»è®¡ç®— key çš„ hash å€¼çš„ï¼Œçœ‹ä¸‹é¢çš„ä»£ç 

![[image-20230428212601977.png]]

é¦–å…ˆè·å– key çš„ hashCode å€¼ï¼Œç„¶åå³ç§» 16 ä½ å¼‚æˆ–è¿ç®— åŸæ¥çš„ hashCode å€¼ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯ä½¿åŸæ¥çš„ hash å€¼æ›´åŠ å‡åŒ€ï¼Œå‡å°‘ hash å†²çª

æœ‰äº† hash å€¼ä¹‹åï¼Œå°±å¾ˆæ–¹ä¾¿çš„å»è®¡ç®—å½“å‰ key çš„åœ¨æ•°ç»„ä¸­å­˜å‚¨çš„ä¸‹æ ‡ï¼Œçœ‹ä¸‹é¢çš„ä»£ç ï¼š

![[image-20230428212729580.png]]

(n-1)&hash : å¾—åˆ°æ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œä»£æ›¿å–æ¨¡ï¼Œæ€§èƒ½æ›´å¥½ï¼Œæ•°ç»„é•¿åº¦å¿…é¡»æ˜¯ 2 çš„ n æ¬¡å¹‚ï¼Œå¦åˆ™ä¸èƒ½ä»£æ›¿å–æ¨¡

[[HashMap çš„å¯»å€ç®—æ³•]]

## ä¸ºä½• HashMap çš„æ•°ç»„é•¿åº¦ä¸€å®šæ˜¯ 2 çš„æ¬¡å¹‚ï¼Ÿ

ä¸ºäº†èƒ½è®© HashMap å­˜å–é«˜æ•ˆï¼Œå°½é‡è¾ƒå°‘ç¢°æ’ï¼Œä¹Ÿå°±æ˜¯è¦å°½é‡æŠŠæ•°æ®åˆ†é…å‡åŒ€ã€‚æˆ‘ä»¬ä¸Šé¢ä¹Ÿè®²åˆ°äº†è¿‡äº†ï¼ŒHash å€¼çš„èŒƒå›´å€¼ -2147483648 åˆ° 2147483647ï¼Œå‰ååŠ èµ·æ¥å¤§æ¦‚ 40 äº¿çš„æ˜ å°„ç©ºé—´ï¼Œåªè¦å“ˆå¸Œå‡½æ•°æ˜ å°„å¾—æ¯”è¾ƒå‡åŒ€æ¾æ•£ï¼Œä¸€èˆ¬åº”ç”¨æ˜¯å¾ˆéš¾å‡ºç°ç¢°æ’çš„ã€‚ä½†é—®é¢˜æ˜¯ä¸€ä¸ª 40 äº¿é•¿åº¦çš„æ•°ç»„ï¼Œå†…å­˜æ˜¯æ”¾ä¸ä¸‹çš„ã€‚æ‰€ä»¥è¿™ä¸ªæ•£åˆ—å€¼æ˜¯ä¸èƒ½ç›´æ¥æ‹¿æ¥ç”¨çš„ã€‚ç”¨ä¹‹å‰è¿˜è¦å…ˆåšå¯¹æ•°ç»„çš„é•¿åº¦å–æ¨¡è¿ç®—ï¼Œå¾—åˆ°çš„ä½™æ•°æ‰èƒ½ç”¨æ¥è¦å­˜æ”¾çš„ä½ç½®ä¹Ÿå°±æ˜¯å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ã€‚

**è¿™ä¸ªç®—æ³•åº”è¯¥å¦‚ä½•è®¾è®¡å‘¢ï¼Ÿ**

æˆ‘ä»¬é¦–å…ˆå¯èƒ½ä¼šæƒ³åˆ°é‡‡ç”¨ % å–ä½™çš„æ“ä½œæ¥å®ç°ã€‚ä½†æ˜¯ï¼Œé‡ç‚¹æ¥äº†ï¼šâ€œ**å–ä½™ (%) æ“ä½œä¸­å¦‚æœé™¤æ•°æ˜¯ 2 çš„å¹‚æ¬¡åˆ™ç­‰ä»·äºä¸å…¶é™¤æ•°å‡ä¸€çš„ä¸ (&) æ“ä½œ**ï¼ˆä¹Ÿå°±æ˜¯è¯´ hash%length == hash&(length-1) çš„å‰ææ˜¯ length æ˜¯ 2 çš„ n æ¬¡æ–¹ï¼›ï¼‰ã€‚â€ å¹¶ä¸” **é‡‡ç”¨äºŒè¿›åˆ¶ä½æ“ä½œ & ç›¸å¯¹äº % èƒ½å¤Ÿæé«˜è¿ç®—æ•ˆç‡**ï¼Œè¿™å°±è§£é‡Šäº† HashMap çš„é•¿åº¦ä¸ºä»€ä¹ˆæ˜¯ 2 çš„å¹‚æ¬¡æ–¹ã€‚

**`HashMap` ä¸­å¸¦æœ‰åˆå§‹å®¹é‡çš„æ„é€ å‡½æ•°ï¼š**

```java
    public HashMap(int initialCapacity, float loadFactor) {
        if (initialCapacity < 0)
            throw new IllegalArgumentException("Illegal initial capacity: " +
                                               initialCapacity);
        if (initialCapacity > MAXIMUM_CAPACITY)
            initialCapacity = MAXIMUM_CAPACITY;
        if (loadFactor <= 0 || Float.isNaN(loadFactor))
            throw new IllegalArgumentException("Illegal load factor: " +
                                               loadFactor);
        this.loadFactor = loadFactor;
        this.threshold = tableSizeFor(initialCapacity);
    }
     public HashMap(int initialCapacity) {
        this(initialCapacity, DEFAULT_LOAD_FACTOR);
    }
```

ä¸‹é¢è¿™ä¸ªæ–¹æ³•ä¿è¯äº† `HashMap` æ€»æ˜¯ä½¿ç”¨ 2 çš„å¹‚ä½œä¸ºå“ˆå¸Œè¡¨çš„å¤§å°ã€‚

```java
    /**
     * Returns a power of two size for the given target capacity.
     */
    static final int tableSizeFor(int cap) {
        int n = cap - 1;
        n |= n >>> 1;
        n |= n >>> 2;
        n |= n >>> 4;
        n |= n >>> 8;
        n |= n >>> 16;
        return (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;
    }
```

[[ä¸ºä½• HashMap çš„æ•°ç»„é•¿åº¦ä¸€å®šæ˜¯ 2 çš„æ¬¡å¹‚ï¼Ÿ]]

## HashMap åœ¨ 1.7 æƒ…å†µä¸‹çš„å¤šçº¿ç¨‹æ­»å¾ªç¯é—®é¢˜

jdk7 çš„çš„æ•°æ®ç»“æ„æ˜¯ï¼šæ•°ç»„ + é“¾è¡¨

åœ¨æ•°ç»„è¿›è¡Œæ‰©å®¹çš„æ—¶å€™ï¼Œå› ä¸ºé“¾è¡¨æ˜¯å¤´æ’æ³•ï¼Œåœ¨è¿›è¡Œæ•°æ®è¿ç§»çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰å¯èƒ½å¯¼è‡´æ­»å¾ªç¯

![[image-20230428213115071.png]]

- å˜é‡ e æŒ‡å‘çš„æ˜¯éœ€è¦è¿ç§»çš„å¯¹è±¡
- å˜é‡ next æŒ‡å‘çš„æ˜¯ä¸‹ä¸€ä¸ªéœ€è¦è¿ç§»çš„å¯¹è±¡
- Jdk1.7 ä¸­çš„é“¾è¡¨é‡‡ç”¨çš„å¤´æ’æ³•
- åœ¨æ•°æ®è¿ç§»çš„è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰æ–°çš„å¯¹è±¡äº§ç”Ÿï¼Œåªæ˜¯æ”¹å˜äº†å¯¹è±¡çš„å¼•ç”¨

äº§ç”Ÿæ­»å¾ªç¯çš„è¿‡ç¨‹ï¼š

çº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 çš„å˜é‡ e å’Œ next éƒ½å¼•ç”¨äº†è¿™ä¸ªä¸¤ä¸ªèŠ‚ç‚¹

![[image-20230428213533483.png|500]]

çº¿ç¨‹ 2 æ‰©å®¹åï¼Œç”±äºå¤´æ’æ³•ï¼Œé“¾è¡¨é¡ºåºé¢ å€’ï¼Œä½†æ˜¯çº¿ç¨‹ 1 çš„ä¸´æ—¶å˜é‡ e å’Œ next è¿˜å¼•ç”¨äº†è¿™ä¸¤ä¸ªèŠ‚ç‚¹

![[image-20230428214732877.png|500]]

ç¬¬ä¸€æ¬¡å¾ªç¯

ç”±äºçº¿ç¨‹ 2 è¿ç§»çš„æ—¶å€™ï¼Œå·²ç»æŠŠ B çš„ next æ‰§è¡Œäº† A

![[image-20230428214806072.png|500]]

ç¬¬äºŒæ¬¡å¾ªç¯

![[image-20230428214908652.png|500]]

ç¬¬ä¸‰æ¬¡å¾ªç¯

![[image-20230428214937231.png|500]]

[[HashMap åœ¨ 1.7 æƒ…å†µä¸‹çš„å¤šçº¿ç¨‹æ­»å¾ªç¯é—®é¢˜]]

## HashMap ä¸ºä»€ä¹ˆçº¿ç¨‹ä¸å®‰å…¨ï¼Ÿ

JDK1.7 åŠä¹‹å‰ç‰ˆæœ¬ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œ`HashMap` æ‰©å®¹æ—¶ä¼šé€ æˆæ­»å¾ªç¯å’Œæ•°æ®ä¸¢å¤±çš„é—®é¢˜ã€‚

æ•°æ®ä¸¢å¤±è¿™ä¸ªåœ¨ JDK1.7 å’Œ JDK 1.8 ä¸­éƒ½å­˜åœ¨ï¼Œè¿™é‡Œä»¥ JDK 1.8 ä¸ºä¾‹è¿›è¡Œä»‹ç»ã€‚

JDK 1.8 åï¼Œåœ¨ `HashMap` ä¸­ï¼Œå¤šä¸ªé”®å€¼å¯¹å¯èƒ½ä¼šè¢«åˆ†é…åˆ°åŒä¸€ä¸ªæ¡¶ï¼ˆbucketï¼‰ï¼Œå¹¶ä»¥é“¾è¡¨æˆ–çº¢é»‘æ ‘çš„å½¢å¼å­˜å‚¨ã€‚å¤šä¸ªçº¿ç¨‹å¯¹ `HashMap` çš„ `put` æ“ä½œä¼šå¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨ï¼Œå…·ä½“æ¥è¯´ä¼šæœ‰æ•°æ®è¦†ç›–çš„é£é™©ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

- ä¸¤ä¸ªçº¿ç¨‹ 1,2 åŒæ—¶è¿›è¡Œ put æ“ä½œï¼Œå¹¶ä¸”å‘ç”Ÿäº†å“ˆå¸Œå†²çªï¼ˆhash å‡½æ•°è®¡ç®—å‡ºçš„æ’å…¥ä¸‹æ ‡æ˜¯ç›¸åŒçš„ï¼‰ã€‚
- ä¸åŒçš„çº¿ç¨‹å¯èƒ½åœ¨ä¸åŒçš„æ—¶é—´ç‰‡è·å¾— CPU æ‰§è¡Œçš„æœºä¼šï¼Œå½“å‰çº¿ç¨‹ 1 æ‰§è¡Œå®Œå“ˆå¸Œå†²çªåˆ¤æ–­åï¼Œç”±äºæ—¶é—´ç‰‡è€—å°½æŒ‚èµ·ã€‚çº¿ç¨‹ 2 å…ˆå®Œæˆäº†æ’å…¥æ“ä½œã€‚
- éšåï¼Œçº¿ç¨‹ 1 è·å¾—æ—¶é—´ç‰‡ï¼Œç”±äºä¹‹å‰å·²ç»è¿›è¡Œè¿‡ hash ç¢°æ’çš„åˆ¤æ–­ï¼Œæ‰€æœ‰æ­¤æ—¶ä¼šç›´æ¥è¿›è¡Œæ’å…¥ï¼Œè¿™å°±å¯¼è‡´çº¿ç¨‹ 2 æ’å…¥çš„æ•°æ®è¢«çº¿ç¨‹ 1 è¦†ç›–äº†ã€‚

```java
public V put(K key, V value) {
    return putVal(hash(key), key, value, false, true);
}

final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
                   boolean evict) {
    // ...
    // åˆ¤æ–­æ˜¯å¦å‡ºç° hash ç¢°æ’
    // (n - 1) & hash ç¡®å®šå…ƒç´ å­˜æ”¾åœ¨å“ªä¸ªæ¡¶ä¸­ï¼Œæ¡¶ä¸ºç©ºï¼Œæ–°ç”Ÿæˆç»“ç‚¹æ”¾å…¥æ¡¶ä¸­(æ­¤æ—¶ï¼Œè¿™ä¸ªç»“ç‚¹æ˜¯æ”¾åœ¨æ•°ç»„ä¸­)
    if ((p = tab[i = (n - 1) & hash]) == null)
        tab[i] = newNode(hash, key, value, null);
    // æ¡¶ä¸­å·²ç»å­˜åœ¨å…ƒç´ ï¼ˆå¤„ç†hashå†²çªï¼‰
    else {
    // ...
}
```

è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯è¿™ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ `put` æ“ä½œå¯¼è‡´ `size` çš„å€¼ä¸æ­£ç¡®ï¼Œè¿›è€Œå¯¼è‡´æ•°æ®è¦†ç›–çš„é—®é¢˜ï¼š

1. çº¿ç¨‹ 1 æ‰§è¡Œ `if(++size > threshold)` åˆ¤æ–­æ—¶ï¼Œå‡è®¾è·å¾— `size` çš„å€¼ä¸º 10ï¼Œç”±äºæ—¶é—´ç‰‡è€—å°½æŒ‚èµ·ã€‚
2. çº¿ç¨‹ 2 ä¹Ÿæ‰§è¡Œ `if(++size > threshold)` åˆ¤æ–­ï¼Œè·å¾— `size` çš„å€¼ä¹Ÿä¸º 10ï¼Œå¹¶å°†å…ƒç´ æ’å…¥åˆ°è¯¥æ¡¶ä½ä¸­ï¼Œå¹¶å°† `size` çš„å€¼æ›´æ–°ä¸º 11ã€‚
3. éšåï¼Œçº¿ç¨‹ 1 è·å¾—æ—¶é—´ç‰‡ï¼Œå®ƒä¹Ÿå°†å…ƒç´ æ”¾å…¥æ¡¶ä½ä¸­ï¼Œå¹¶å°† size çš„å€¼æ›´æ–°ä¸º 11ã€‚
4. çº¿ç¨‹ 1ã€2 éƒ½æ‰§è¡Œäº†ä¸€æ¬¡ `put` æ“ä½œï¼Œä½†æ˜¯ `size` çš„å€¼åªå¢åŠ äº† 1ï¼Œä¹Ÿå°±å¯¼è‡´å®é™…ä¸Šåªæœ‰ä¸€ä¸ªå…ƒç´ è¢«æ·»åŠ åˆ°äº† `HashMap` ä¸­ã€‚

```java
public V put(K key, V value) {
    return putVal(hash(key), key, value, false, true);
}

final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
                   boolean evict) {
    // ...
    // å®é™…å¤§å°å¤§äºé˜ˆå€¼åˆ™æ‰©å®¹
    if (++size > threshold)
        resize();
    // æ’å…¥åå›è°ƒ
    afterNodeInsertion(evict);
    return null;
}
```

[[HashMap ä¸ºä»€ä¹ˆçº¿ç¨‹ä¸å®‰å…¨ï¼Ÿ]]

## HashMap å¸¸è§çš„éå†æ–¹å¼ï¼Ÿ

[HashMap çš„ 7 ç§éå†æ–¹å¼ä¸æ€§èƒ½åˆ†æï¼](https://mp.weixin.qq.com/s/zQBN3UvJDhRTKP6SzcZFKw)

**ğŸ› ä¿®æ­£ï¼ˆå‚è§ï¼š[issue#1411](https://github.com/Snailclimb/JavaGuide/issues/1411)ï¼‰**ï¼š

è¿™ç¯‡æ–‡ç« å¯¹äº parallelStream éå†æ–¹å¼çš„æ€§èƒ½åˆ†ææœ‰è¯¯ï¼Œå…ˆè¯´ç»“è®ºï¼š**å­˜åœ¨é˜»å¡æ—¶ parallelStream æ€§èƒ½æœ€é«˜, éé˜»å¡æ—¶ parallelStream æ€§èƒ½æœ€ä½** ã€‚

å½“éå†ä¸å­˜åœ¨é˜»å¡æ—¶, parallelStream çš„æ€§èƒ½æ˜¯æœ€ä½çš„ï¼š

```plain
Benchmark               Mode  Cnt     Score      Error  Units
Test.entrySet           avgt    5   288.651 Â±   10.536  ns/op
Test.keySet             avgt    5   584.594 Â±   21.431  ns/op
Test.lambda             avgt    5   221.791 Â±   10.198  ns/op
Test.parallelStream     avgt    5  6919.163 Â± 1116.139  ns/op
```

åŠ å…¥é˜»å¡ä»£ç  `Thread.sleep(10)` å, parallelStream çš„æ€§èƒ½æ‰æ˜¯æœ€é«˜çš„:

```plain
Benchmark               Mode  Cnt           Score          Error  Units
Test.entrySet           avgt    5  1554828440.000 Â± 23657748.653  ns/op
Test.keySet             avgt    5  1550612500.000 Â±  6474562.858  ns/op
Test.lambda             avgt    5  1551065180.000 Â± 19164407.426  ns/op
Test.parallelStream     avgt    5   186345456.667 Â±  3210435.590  ns/op
```
