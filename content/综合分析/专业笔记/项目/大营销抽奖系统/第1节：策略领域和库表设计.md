---
title: 第1节：策略领域和库表设计
publish: true
---

本节来分析一下策略领域，以及库表的设计。

首先要清楚这一章我们要做什么事。其实就两件事，一是**策略装配**，二是**抽奖**。而我们先要实现策略的装配。

那么什么是策略的装配呢？通俗来讲就是将抽奖的策略，从数据库中查询出来，写入缓存中。

那我们就需要先有一个策略。在设计库表之前，需要先明确出来我们的策略。

我们要进行抽奖动作，动作分为三步：

- 抽奖前：
	- 需要先验证该用户是否为**黑名单**用户，如果是，则给一个兜底奖品即可。
	- 如果不是黑名单用户，则要判断一下是否满足**权重规则**，即如果抽够了 60 次，则可以缩小你能抽到的奖品范围，将最小的奖品去掉。抽够 100 次，再缩小…
- 抽奖中
- 抽奖后

那么，我们就来设计我们的库表（四张）。

## 库表设计

### strategy

策略表，也就是策略的总表，都有啥策略，我可以选其中的某种策略。

然后不同策略可以给配置不同的 rule_models 过滤规则，也就是我们前面所说的**黑名单**和**权重规则**，用于**抽奖前**。（当然，如果想加其他的一些前置过滤规则，也可以添加）

![[Pasted image 20241017200600.png]]

### award

奖品表，也就是我都有什么奖品。

> TODO: 奖品的具体情况是否可以删掉呢，毕竟已经在 strategy_award 表中配置过了奖品的名称等。或者是否可以将这里的描述等，改成类似于“一等奖”、“二等奖”之类的抽象概念，然后在 strategy_award 表中去定义奖品的具体信息。

![[Pasted image 20241017201136.png]]

### strategy_award

策略奖品关系表，不同策略下，都有什么奖品，各种奖品的具体详情，比如 100001 策略下，各 award 的名称、奖品数量、剩余库存、概率、规则模型等。

注意，这里的 rule_models 跟 strategy 表中的就不一样了，这里的是用于**抽奖中**阶段的规则树的，有的奖品需要抽 n 次之后进行解锁，这种规则在抽奖中进行判断。

> TODO: 那么，这两个 rule_models 是否可以再优化一下呢？

![[Pasted image 20241017201307.png]]

### strategy_rule

策略规则表，每个 strategy 策略下，有什么抽奖前的 rule_model，即前置过滤规则（黑名单、权重），以及这些规则的具体 rule_value 规则配置是怎样的。

- rule_weight 的话，就是 60:102,103,104,105 200:106,107 1000:105，表示抽够 60、200、1000 次，奖品的范围。
- rule_blacklist 的话，就是 101: user001, user002, user003，表示黑名单用户以及给他们的兜底奖品 101。

> TODO: 这里的黑名单奖品与 award 表中的不一样，需要修改一下。

> TODO: 这里的 award_id 是不是就可以去掉了。包括 rule_type 也不需要了，之前 rule_type 是用来区分是策略规则（这个名字起的不好，可以叫前置规则）（抽奖前的黑名单、权重规则）还是奖品规则（抽奖中的规则树），现在这里只存放策略规则（抽奖前的黑名单、权重规则）。

![[Pasted image 20241017202624.png]]
