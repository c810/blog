---
title: 第2节：基础层持久化数据
publish: true
---

## 基础层持久化数据

就是创建数据库表对应的 PO 类，已经 DAO 和 mapper.xml。（第一次会写一下过程，后续就会省略）

### 创建分支

先创建分支

一节课程创建一个新的分支，这样即使写错了，还可以回滚。

1. 在 Local 的 main 分支右键新建 `240928-lhp-orm` 分支，创建好之后就自动切换到这个分支上了。
2. 创建分支后，可以 `Ctrl + Shift + K` 提交你的分支到仓库中（也可以开发完成后再 push）。
3. 开发完成后，确保功能都验证正常，可以把分支合并到 master 分支上，再提交一次。也就是图中 Merge 只不过是在你的分支上右键以后，点击 Merge xxx into master

### 创建 PO 类

在 infrastructure 下的 po 中创建 **PO 数据库持久化对象**，一般在 po 包下创建 PO 时，PO 可以省略，默认就是 PO 对象。

里面属性对应数据库表中的字段。

类上需要加 `@Data`。

```java
@Data
public class Award {
    /** 自增ID */
    private Long id;
    /** 抽奖奖品ID - 内部流转使用 */
    private Integer awardId;
    /** 奖品对接标识 - 每一个都是一个对应的发奖策略 */
    private String awardKey;
    /** 奖品配置信息 */
    private String awardConfig;
    /** 奖品内容描述 */
    private String awardDesc;
    /** 创建时间 */
    private Date createTime;
    /** 更新时间 */
    private Date updateTime;
}
```

### 创建对应的 Dao 接口

在 infrastructure 下的 dao 中创建 **Dao 接口**。

接口上需要加 `@Mapper`。

```java
@Mapper
public interface IAwardDao {
}
```

![[image-20240928233631459.png]]

### 创建对应的 mapper.xml 文件

在 app 下的 resource/mybatis/mapper 中创建 **mapper.xml 文件**。

然后写个查询语句，用来测试。

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="pub.lhp.infrastructure.dao.IAwardDao">

    <resultMap id="dataMap" type="pub.lhp.infrastructure.dao.po.Award">
        <id column="id" property="id"/>
        <result column="award_id" property="awardId"/>
        <result column="award_key" property="awardKey"/>
        <result column="award_config" property="awardConfig"/>
        <result column="award_desc" property="awardDesc"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <select id="queryAwardList" resultMap="dataMap">
        select award_id, award_key, award_config, award_desc
        from award
        limit 10
    </select>

</mapper>
```

![[image-20241001103747607.png]]

### 在 Dao 接口中添加对应的方法声明

与 mapper.xml 中的方法名相同。

```java
@Mapper
public interface IAwardDao {
    List<Award> queryAwardList();
}
```

### 修改 application 配置文件

检查并修改 app 下的 `application-dev.yml` 文件。

```yaml
# 数据库配置；启动时配置数据库资源信息
spring:
  datasource:
    username: root
    password: xxxxxx
    url: jdbc:mysql://117.72.86.192:13306/big_market?useUnicode=true&characterEncoding=utf8&autoReconnect=true&zeroDateTimeBehavior=convertToNull&serverTimezone=UTC&useSSL=true
    driver-class-name: com.mysql.cj.jdbc.Driver
    
    
    
# MyBatis 配置【如需使用记得打开】
mybatis:
  mapper-locations: classpath:/mybatis/mapper/*.xml
  config-location:  classpath:/mybatis/config/mybatis-config.xml
```

### 单元测试

在 app 下的 test 中，创建要测试方法对应的包，然后编写测试代码。

需要添加

例如，要测试 infrastructure 下的 IAwardDao 接口中的方法，就先建一个 infrastructure 包，然后创建 AwardDaoTest 类：

```java
// @Slf4j: 这是Lombok库提供的一个注解，它会自动生成一个名为log的Logger对象，方便在类中进行日志记录。
// @RunWith(SpringRunner.class): 指定运行器为SpringRunner，这样可以支持Spring TestContext Framework的功能。
// @SpringBootTest: 表示这是一个Spring Boot应用的集成测试，它将启动整个Spring应用上下文来执行测试。
@Slf4j
@RunWith(SpringRunner.class)
@SpringBootTest
public class AwardDaoTest {

    // 注入奖品持久化 DAO
    @Resource
    private IAwardDao awardDao;

    @Test
    public void testQueryAwardList() {
        List<Award> awards = awardDao.queryAwardList();
        // 将奖品列表转换成JSON字符串格式输出
        log.info("奖品列表: {}", JSON.toJSONString(awards));
    }
}
```

### 提交并合并分支

**提交并推送代码**

测试通过后，提交代码。

先 `Ctrl + K` 提交：`feat: 基础层持久化数据`，然后 `Ctrl + Shift + K` 推送。

**合并到 main 分支**

先 check out 切换到 main 分支，然后右键需要合并的分支，然后 merge 合并到 main。

这里相当于在本地合并了，所以还需要推送 main 到远端，也就是再 `Ctrl + Shift + K` 推送到远程仓库即可。
